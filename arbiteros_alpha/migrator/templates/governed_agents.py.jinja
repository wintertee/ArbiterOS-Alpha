"""ArbiterOS governance layer for {{ domain }}.

This module provides the ArbiterOS instance and decorator utilities for wrapping
agent node functions with policy-driven governance.

Generated by ArbiterOS Migration Tool.
"""

import functools
import logging
from typing import Any, Callable, TypeVar

from arbiteros_alpha import ArbiterOSAlpha
from arbiteros_alpha.instructions import (
{% for import in instruction_imports %}
    {{ import }},
{% endfor %}
)

logger = logging.getLogger(__name__)

# Global ArbiterOS instance for the {{ domain }} framework
arbiter_os = ArbiterOSAlpha(backend="{{ backend }}")

# Instruction type mappings for different agent roles
{% for wrapper in wrappers %}
{{ wrapper.constant_name }} = {{ wrapper.instruction_import }}
{% endfor %}

# Type variable for function decoration
F = TypeVar("F", bound=Callable[..., Any])

{% for wrapper in wrappers %}

def {{ wrapper.wrapper_name }}(func: F) -> F:
    """Decorator wrapper for {{ wrapper.role_description }}.

    Applies {{ wrapper.instruction_type }} instruction type governance to functions
    that {{ wrapper.function_description }}.

    Args:
        func: The node function to wrap.

    Returns:
        The wrapped function with ArbiterOS governance.
    """
    return arbiter_os.instruction({{ wrapper.constant_name }})(func)

{% endfor %}

def wrap_factory_result(wrapper_func: Callable[[F], F]) -> Callable:
    """Higher-order decorator for wrapping factory function results.

    This decorator is used to wrap the inner function returned by agent
    factory functions without modifying the factory function itself.

    Args:
        wrapper_func: The governance wrapper to apply.

    Returns:
        A decorator that wraps the result of the factory function.

    Example:
        >>> @wrap_factory_result(govern_analyst)
        ... def create_analyst(llm):
        ...     def analyst_node(state):
        ...         return {"report": "..."}
        ...     return analyst_node
    """

    def factory_decorator(factory_func: Callable) -> Callable:
        @functools.wraps(factory_func)
        def wrapper(*args, **kwargs):
            # Call the original factory to get the node function
            node_func = factory_func(*args, **kwargs)
            # Wrap the node function with governance
            governed_func = wrapper_func(node_func)
            return governed_func

        return wrapper

    return factory_decorator


def get_arbiter_os() -> ArbiterOSAlpha:
    """Get the global ArbiterOS instance.

    Returns:
        The configured ArbiterOSAlpha instance.
    """
    return arbiter_os


def reset_arbiter_os() -> None:
    """Reset the global ArbiterOS instance.

    Creates a new ArbiterOS instance, clearing all history and policies.
    Useful for testing or when starting fresh executions.
    """
    global arbiter_os
    arbiter_os = ArbiterOSAlpha(backend="{{ backend }}")
    logger.info("ArbiterOS instance reset")
